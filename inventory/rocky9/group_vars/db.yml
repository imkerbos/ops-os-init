---
# =============================================================================
# 数据库节点覆盖参数 — MySQL / PostgreSQL / Redis 等
# =============================================================================
# 此文件仅包含需要覆盖 rocky9.yml 默认值的参数
# 未列出的参数自动继承 group_vars/rocky9.yml
# =============================================================================

ops_sysctl_params:
  # --- TCP 优化（继承通用值）---
  net.ipv4.tcp_fin_timeout: 15
  net.ipv4.tcp_tw_reuse: 1
  net.ipv4.tcp_keepalive_time: 600
  net.ipv4.tcp_keepalive_intvl: 30
  net.ipv4.tcp_keepalive_probes: 3
  net.ipv4.tcp_max_syn_backlog: 8192
  net.ipv4.tcp_syncookies: 1
  net.ipv4.tcp_syn_retries: 2
  net.ipv4.tcp_synack_retries: 2
  net.ipv4.tcp_slow_start_after_idle: 0
  net.ipv4.tcp_mtu_probing: 1
  net.ipv4.tcp_rmem: "4096 87380 16777216"
  net.ipv4.tcp_wmem: "4096 65536 16777216"

  # --- 网络核心 ---
  net.core.somaxconn: 32768
  net.core.netdev_max_backlog: 16384
  net.core.rmem_max: 16777216
  net.core.wmem_max: 16777216

  # --- IPv4 安全 ---
  net.ipv4.ip_forward: 0
  net.ipv4.conf.all.rp_filter: 1
  net.ipv4.conf.default.rp_filter: 1
  net.ipv4.conf.all.accept_redirects: 0
  net.ipv4.conf.default.accept_redirects: 0
  net.ipv4.conf.all.send_redirects: 0
  net.ipv4.conf.default.send_redirects: 0
  net.ipv4.conf.all.accept_source_route: 0
  net.ipv4.conf.default.accept_source_route: 0
  net.ipv4.ip_local_port_range: "10000 65535"

  # --- IPv6 ---
  net.ipv6.conf.all.disable_ipv6: 1
  net.ipv6.conf.default.disable_ipv6: 1

  # --- 文件系统 ---
  fs.file-max: 2097152
  fs.nr_open: 2097152
  fs.inotify.max_user_watches: 524288
  fs.inotify.max_user_instances: 8192

  # --- 虚拟内存（数据库优化）---
  vm.swappiness: 1                      # ← 数据库建议尽量不用 swap（通用值 10）
  vm.max_map_count: 262144
  vm.dirty_ratio: 40                    # ← 允许更多脏页缓存，减少频繁刷盘（通用值 20）
  vm.dirty_background_ratio: 10         # ← 后台刷盘阈值适当提高（通用值 5）
  vm.dirty_expire_centisecs: 3000       # ← 脏页过期时间 30 秒，平衡写入延迟
  vm.dirty_writeback_centisecs: 500     # ← 刷盘间隔 5 秒

  # --- 内核 ---
  kernel.sysrq: 0
  kernel.pid_max: 4194304
  kernel.dmesg_restrict: 1
  kernel.kptr_restrict: 2
  kernel.yama.ptrace_scope: 1
  kernel.randomize_va_space: 2
  fs.suid_dumpable: 0

  # --- 网络安全（增强）---
  net.ipv4.conf.all.log_martians: 1
  net.ipv4.conf.default.log_martians: 1
  net.ipv4.icmp_echo_ignore_broadcasts: 1
  net.ipv4.icmp_ignore_bogus_error_responses: 1
  net.ipv4.conf.all.secure_redirects: 0
  net.ipv4.conf.default.secure_redirects: 0
  net.ipv6.conf.all.accept_redirects: 0
  net.ipv6.conf.default.accept_redirects: 0
  net.ipv6.conf.all.accept_source_route: 0
  net.ipv6.conf.default.accept_source_route: 0

# --- 内核资源限制（数据库优化）---
ops_limits:
  - domain: "*"
    type: "soft"
    item: "nofile"
    value: 655360
  - domain: "*"
    type: "hard"
    item: "nofile"
    value: 655360
  - domain: "*"
    type: "soft"
    item: "nproc"
    value: 131072
  - domain: "*"
    type: "hard"
    item: "nproc"
    value: 131072
  - domain: "*"
    type: "soft"
    item: "memlock"
    value: "unlimited"
  - domain: "*"
    type: "hard"
    item: "memlock"
    value: "unlimited"
  - domain: "*"
    type: "soft"
    item: "core"
    value: "unlimited"                  # ← 数据库允许 core dump 用于崩溃排查（通用值 0）
  - domain: "*"
    type: "hard"
    item: "core"
    value: "unlimited"

# --- SSH（数据库节点允许 TCP 转发，方便隧道连接）---
ops_ssh_allow_tcp_forwarding: "yes"     # ← 允许 SSH 隧道连数据库（通用值 no）
