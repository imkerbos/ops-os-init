---
# =============================================================================
# init-users — 用户与权限管理
# =============================================================================

- name: 创建运维用户
  ansible.builtin.user:
    name: "{{ item.name }}"
    shell: "{{ item.shell }}"
    groups: "{{ item.groups }}"
    append: true
    create_home: true
  loop: "{{ ops_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: 设置用户 home 目录权限
  ansible.builtin.file:
    path: "/home/{{ item.name }}"
    mode: "{{ item.home_mode }}"
  loop: "{{ ops_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: 部署 SSH 公钥
  ansible.posix.authorized_key:
    user: "{{ item.name }}"
    state: present
    key: "{{ lookup('file', item.ssh_key_file) }}"
  loop: "{{ ops_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: 配置 sudoers 权限
  ansible.builtin.copy:
    content: |
      # Managed by ops-os-init
      {{ item.name }} ALL=(ALL) {{ 'NOPASSWD: ALL' if item.sudo_nopasswd else 'ALL' }}
    dest: "/etc/sudoers.d/{{ item.name }}"
    owner: root
    group: root
    mode: "0440"
    validate: "visudo -cf %s"
  loop: "{{ ops_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: 锁定无用系统账户
  ansible.builtin.command:
    cmd: "usermod --lock {{ item }}"
  loop: "{{ ops_users_lock }}"
  register: lock_result
  changed_when: lock_result.rc == 0
  failed_when:
    - lock_result.rc != 0
    - "'does not exist' not in lock_result.stderr"

# =============================================================================
# 密码策略与账号安全加固
# =============================================================================

- name: 配置密码老化策略 — PASS_MAX_DAYS
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MAX_DAYS'
    line: "PASS_MAX_DAYS\t{{ ops_password_max_days }}"

- name: 配置密码老化策略 — PASS_MIN_DAYS
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MIN_DAYS'
    line: "PASS_MIN_DAYS\t{{ ops_password_min_days }}"

- name: 配置密码老化策略 — PASS_WARN_AGE
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_WARN_AGE'
    line: "PASS_WARN_AGE\t{{ ops_password_warn_age }}"

- name: 部署密码复杂度策略
  ansible.builtin.template:
    src: pwquality.conf.j2
    dest: /etc/security/pwquality.conf
    owner: root
    group: root
    mode: "0644"

- name: 部署账户锁定策略
  ansible.builtin.template:
    src: faillock.conf.j2
    dest: /etc/security/faillock.conf
    owner: root
    group: root
    mode: "0644"

# --- authselect / PAM faillock 分支 ---

- name: 启用 authselect with-faillock (RedHat)
  ansible.builtin.command:
    cmd: authselect select sssd with-faillock with-pamaccess --force
  register: authselect_result
  changed_when: "'Profile changed' in authselect_result.stdout or 'already selected' not in authselect_result.stdout"
  failed_when: authselect_result.rc != 0
  when: ansible_os_family == "RedHat"

- name: 配置 PAM faillock — common-auth (Debian)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-auth
    insertbefore: '^auth\s+\[success=1'
    line: "auth\trequired\tpam_faillock.so preauth silent deny={{ ops_faillock_deny }} unlock_time={{ ops_faillock_unlock_time }} fail_interval={{ ops_faillock_fail_interval }}"
    regexp: '^auth\s+required\s+pam_faillock\.so\s+preauth'
  when: ansible_os_family == "Debian"

- name: 配置 PAM faillock — common-auth authfail (Debian)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-auth
    insertafter: '^auth\s+\[success=1'
    line: "auth\t[default=die]\tpam_faillock.so authfail deny={{ ops_faillock_deny }} unlock_time={{ ops_faillock_unlock_time }} fail_interval={{ ops_faillock_fail_interval }}"
    regexp: '^auth\s+\[default=die\]\s+pam_faillock\.so\s+authfail'
  when: ansible_os_family == "Debian"

- name: 配置 PAM faillock — common-account (Debian)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-account
    insertbefore: BOF
    line: "account\trequired\tpam_faillock.so"
    regexp: '^account\s+required\s+pam_faillock\.so'
  when: ansible_os_family == "Debian"

# --- su 限制 ---

- name: 限制 su 仅 wheel 组用户 (RedHat)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/su
    regexp: '^#?\s*auth\s+required\s+pam_wheel\.so\s+use_uid'
    line: "auth\t\trequired\tpam_wheel.so use_uid"
  when: ops_su_restrict_wheel and ansible_os_family == "RedHat"

- name: 限制 su 仅 sudo 组用户 (Debian)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/su
    regexp: '^#?\s*auth\s+required\s+pam_wheel\.so\s+'
    line: "auth\t\trequired\tpam_wheel.so use_uid group=sudo"
  when: ops_su_restrict_wheel and ansible_os_family == "Debian"

- name: 部署全局安全环境变量（umask + TMOUT）
  ansible.builtin.template:
    src: profile.d-99-ops-security.sh.j2
    dest: /etc/profile.d/99-ops-security.sh
    owner: root
    group: root
    mode: "0644"
