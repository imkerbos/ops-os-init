---
# =============================================================================
# init-ssh — SSH 安全加固
# =============================================================================

- name: 确保 sshd_config.d 目录存在
  ansible.builtin.file:
    path: /etc/ssh/sshd_config.d
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: 部署 SSH 主配置加固
  ansible.builtin.template:
    src: sshd_config.d-99-ops-init.conf.j2
    dest: /etc/ssh/sshd_config.d/99-ops-init.conf
    owner: root
    group: root
    mode: "0600"
  notify: Restart sshd

- name: 校验 sshd 完整配置
  ansible.builtin.command: sshd -t
  changed_when: false

- name: 部署应急 SSH 配置文件
  ansible.builtin.template:
    src: sshd_config.d-99-ops-emergency.conf.j2
    dest: /etc/ssh/sshd-emergency.conf
    owner: root
    group: root
    mode: "0600"
  when: ops_ssh_emergency_enabled
  notify: Restart sshd-emergency

- name: 创建应急 sshd systemd 服务
  ansible.builtin.copy:
    content: |
      # Managed by ops-os-init — 应急 SSH 服务
      [Unit]
      Description=OpenSSH Emergency Server
      After=network.target

      [Service]
      Type=notify
      ExecStart=/usr/sbin/sshd -D -f /etc/ssh/sshd-emergency.conf
      ExecReload=/bin/kill -HUP $MAINPID
      Restart=on-failure
      RestartSec=42s

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/sshd-emergency.service
    owner: root
    group: root
    mode: "0644"
  when: ops_ssh_emergency_enabled
  notify: Restart sshd-emergency

- name: 启动并启用应急 sshd 服务
  ansible.builtin.systemd:
    name: sshd-emergency
    state: started
    enabled: true
    daemon_reload: true
  when: ops_ssh_emergency_enabled

- name: 部署登录横幅 /etc/issue.net
  ansible.builtin.template:
    src: issue.net.j2
    dest: /etc/issue.net
    owner: root
    group: root
    mode: "0644"
  when: ops_ssh_banner_enabled

- name: 部署登录横幅 /etc/issue
  ansible.builtin.template:
    src: issue.net.j2
    dest: /etc/issue
    owner: root
    group: root
    mode: "0644"
  when: ops_ssh_banner_enabled

- name: 清空 /etc/motd 避免信息泄露
  ansible.builtin.copy:
    content: ""
    dest: /etc/motd
    owner: root
    group: root
    mode: "0644"
  when: ops_ssh_banner_enabled
