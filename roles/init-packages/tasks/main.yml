---
# =============================================================================
# init-packages — 包管理
# =============================================================================

# =============================================================================
# YUM 仓库管理（RedHat 系）
# =============================================================================

- name: 部署 Rocky 基础仓库配置
  ansible.builtin.template:
    src: rocky.repo.j2
    dest: /etc/yum.repos.d/rocky.repo
    owner: root
    group: root
    mode: "0644"
  when: ops_repo_managed and ansible_os_family == "RedHat"

- name: 移除默认 Rocky 仓库文件（避免冲突）
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/yum.repos.d/rocky-addons.repo
    - /etc/yum.repos.d/rocky-devel.repo
    - /etc/yum.repos.d/rocky-extras.repo
  when: ops_repo_managed and ansible_os_family == "RedHat"

- name: 安装 EPEL 仓库
  ansible.builtin.dnf:
    name: epel-release
    state: present
  when: ansible_os_family == "RedHat"

- name: 部署 EPEL 仓库配置
  ansible.builtin.template:
    src: epel.repo.j2
    dest: /etc/yum.repos.d/epel.repo
    owner: root
    group: root
    mode: "0644"
  when: ops_repo_managed and ansible_os_family == "RedHat"

- name: 移除 EPEL 默认仓库文件（避免冲突）
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/yum.repos.d/epel-cisco-openh264.repo
    - /etc/yum.repos.d/epel-testing.repo
  when: ops_repo_managed and ansible_os_family == "RedHat"

- name: 清理 DNF 缓存
  ansible.builtin.command: dnf clean all
  changed_when: false
  when: ops_repo_managed and ansible_os_family == "RedHat"

# =============================================================================
# APT 源管理（Debian 系）
# =============================================================================

- name: 部署 APT 源配置
  ansible.builtin.template:
    src: sources.list.j2
    dest: /etc/apt/sources.list
    owner: root
    group: root
    mode: "0644"
  when: ops_repo_managed and ansible_os_family == "Debian"

- name: 更新 APT 缓存
  ansible.builtin.apt:
    update_cache: true
  changed_when: false
  when: ops_repo_managed and ansible_os_family == "Debian"

# =============================================================================
# 安装 / 移除包
# =============================================================================

- name: 安装运维工具包 (RedHat)
  ansible.builtin.dnf:
    name: "{{ ops_packages_install }}"
    state: present
  when: ansible_os_family == "RedHat"

- name: 安装运维工具包 (Debian)
  ansible.builtin.apt:
    name: "{{ ops_packages_install }}"
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: 移除高风险默认包 (RedHat)
  ansible.builtin.dnf:
    name: "{{ ops_packages_remove }}"
    state: absent
  when: ansible_os_family == "RedHat"

- name: 移除高风险默认包 (Debian)
  ansible.builtin.apt:
    name: "{{ ops_packages_remove }}"
    state: absent
    purge: true
  when: ansible_os_family == "Debian"

# =============================================================================
# Docker 安装（仅 ops_docker_enabled: true 时执行）
# =============================================================================

- name: 移除系统自带的旧版容器包 (RedHat)
  ansible.builtin.dnf:
    name:
      - docker
      - docker-client
      - docker-client-latest
      - docker-common
      - docker-latest
      - docker-latest-logrotate
      - docker-logrotate
      - docker-engine
      - podman
      - buildah
    state: absent
  when: ops_docker_enabled and ansible_os_family == "RedHat"

- name: 移除系统自带的旧版容器包 (Debian)
  ansible.builtin.apt:
    name:
      - docker
      - docker-engine
      - docker.io
      - containerd
      - runc
    state: absent
  when: ops_docker_enabled and ansible_os_family == "Debian"

- name: 添加 Docker 官方 YUM 仓库
  ansible.builtin.yum_repository:
    name: docker-ce
    description: Docker CE Stable
    baseurl: https://download.docker.com/linux/centos/$releasever/$basearch/stable
    gpgcheck: true
    gpgkey: https://download.docker.com/linux/centos/gpg
    enabled: true
  when: ops_docker_enabled and ansible_os_family == "RedHat"

- name: 安装 Docker GPG 密钥 (Debian)
  ansible.builtin.apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present
  when: ops_docker_enabled and ansible_os_family == "Debian"

- name: 添加 Docker 官方 APT 仓库 (Debian)
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    filename: docker-ce
  when: ops_docker_enabled and ansible_os_family == "Debian"

- name: 安装 Docker CE (RedHat)
  ansible.builtin.dnf:
    name: "{{ ops_docker_packages }}"
    state: present
  when: ops_docker_enabled and ansible_os_family == "RedHat"

- name: 安装 Docker CE (Debian)
  ansible.builtin.apt:
    name: "{{ ops_docker_packages }}"
    state: present
    update_cache: true
  when: ops_docker_enabled and ansible_os_family == "Debian"

- name: 启动并启用 Docker 服务
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: true
  when: ops_docker_enabled

- name: 将运维用户加入 docker 组
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: docker
    append: true
  loop: "{{ ops_users }}"
  loop_control:
    label: "{{ item.name }}"
  when: ops_docker_enabled

# =============================================================================
# Node Exporter 安装（仅 ops_node_exporter_enabled: true 时执行）
# =============================================================================

- name: 检查 node_exporter 是否已安装
  ansible.builtin.stat:
    path: /usr/local/bin/node_exporter
  register: _node_exporter_bin
  when: ops_node_exporter_enabled

- name: 创建 node_exporter 系统用户
  ansible.builtin.user:
    name: node_exporter
    system: true
    shell: /usr/sbin/nologin
    create_home: false
  when: ops_node_exporter_enabled

- name: 下载 node_exporter
  ansible.builtin.unarchive:
    src: "{{ ops_node_exporter_download_url }}"
    dest: /tmp
    remote_src: true
  when: ops_node_exporter_enabled and not (_node_exporter_bin.stat.exists | default(false))

- name: 安装 node_exporter 二进制文件
  ansible.builtin.copy:
    src: "/tmp/node_exporter-{{ ops_node_exporter_version }}.linux-amd64/node_exporter"
    dest: /usr/local/bin/node_exporter
    owner: root
    group: root
    mode: "0755"
    remote_src: true
  when: ops_node_exporter_enabled and not (_node_exporter_bin.stat.exists | default(false))
  notify: Restart node_exporter

- name: 清理 node_exporter 临时文件
  ansible.builtin.file:
    path: "/tmp/node_exporter-{{ ops_node_exporter_version }}.linux-amd64"
    state: absent
  when: ops_node_exporter_enabled

- name: 部署 node_exporter systemd 服务
  ansible.builtin.copy:
    content: |
      # Managed by ops-os-init — Node Exporter
      [Unit]
      Description=Prometheus Node Exporter
      Documentation=https://github.com/prometheus/node_exporter
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      User=node_exporter
      Group=node_exporter
      ExecStart=/usr/local/bin/node_exporter \
        --web.listen-address={{ ops_node_exporter_listen }}
      Restart=on-failure
      RestartSec=5s

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/node_exporter.service
    owner: root
    group: root
    mode: "0644"
  when: ops_node_exporter_enabled
  notify: Restart node_exporter

- name: 启动并启用 node_exporter 服务
  ansible.builtin.systemd:
    name: node_exporter
    state: started
    enabled: true
    daemon_reload: true
  when: ops_node_exporter_enabled
