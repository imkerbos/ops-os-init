---
# =============================================================================
# init-kernel — 内核参数与资源限制
# =============================================================================

- name: 配置系统资源限制
  ansible.builtin.template:
    src: limits.d-99-ops-init.conf.j2
    dest: /etc/security/limits.d/99-ops-init.conf
    owner: root
    group: root
    mode: "0644"

# =============================================================================
# systemd DefaultLimit 配置
# Ubuntu/Debian 的 systemd 默认 DefaultLimitNOFILE=1024:524288，
# 会覆盖 limits.d 的设置，必须同步配置 systemd 的默认限制。
# Rocky/RHEL 也一并配置，确保一致性。
# =============================================================================

- name: 提取 nofile/nproc hard 限制值
  ansible.builtin.set_fact:
    _ops_nofile_hard: "{{ (ops_limits | selectattr('item', 'equalto', 'nofile') | selectattr('type', 'equalto', 'hard') | first).value }}"
    _ops_nproc_hard: "{{ (ops_limits | selectattr('item', 'equalto', 'nproc') | selectattr('type', 'equalto', 'hard') | first).value }}"

- name: 配置 systemd system.conf — DefaultLimitNOFILE
  ansible.builtin.lineinfile:
    path: /etc/systemd/system.conf
    regexp: '^#?DefaultLimitNOFILE='
    line: "DefaultLimitNOFILE={{ _ops_nofile_hard }}:{{ _ops_nofile_hard }}"
    insertafter: '^\[Manager\]'
  notify: Reload systemd

- name: 配置 systemd system.conf — DefaultLimitNPROC
  ansible.builtin.lineinfile:
    path: /etc/systemd/system.conf
    regexp: '^#?DefaultLimitNPROC='
    line: "DefaultLimitNPROC={{ _ops_nproc_hard }}:{{ _ops_nproc_hard }}"
    insertafter: '^\[Manager\]'
  notify: Reload systemd

- name: 配置 systemd user.conf — DefaultLimitNOFILE
  ansible.builtin.lineinfile:
    path: /etc/systemd/user.conf
    regexp: '^#?DefaultLimitNOFILE='
    line: "DefaultLimitNOFILE={{ _ops_nofile_hard }}:{{ _ops_nofile_hard }}"
    insertafter: '^\[Manager\]'
  notify: Reload systemd

- name: 配置 systemd user.conf — DefaultLimitNPROC
  ansible.builtin.lineinfile:
    path: /etc/systemd/user.conf
    regexp: '^#?DefaultLimitNPROC='
    line: "DefaultLimitNPROC={{ _ops_nproc_hard }}:{{ _ops_nproc_hard }}"
    insertafter: '^\[Manager\]'
  notify: Reload systemd

# =============================================================================
# SSH 服务 systemd override
# sshd 进程的硬限制决定了 PAM pam_limits.so 能设置的上限。
# 必须通过 systemd override 确保 sshd 进程自身有足够高的限制，
# 否则 PAM 无法将登录会话的限制提升到超过 sshd 进程的硬限制。
# =============================================================================

- name: 获取 SSH 服务名
  ansible.builtin.set_fact:
    _ops_ssh_service: "{{ 'ssh' if ansible_os_family == 'Debian' else 'sshd' }}"

- name: 创建 SSH 服务 systemd override 目录
  ansible.builtin.file:
    path: "/etc/systemd/system/{{ _ops_ssh_service }}.service.d"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: 部署 SSH 服务资源限制 override
  ansible.builtin.copy:
    content: |
      # Managed by ops-os-init — 确保 sshd 进程有足够高的资源限制
      [Service]
      LimitNOFILE={{ _ops_nofile_hard }}:{{ _ops_nofile_hard }}
      LimitNPROC={{ _ops_nproc_hard }}:{{ _ops_nproc_hard }}
    dest: "/etc/systemd/system/{{ _ops_ssh_service }}.service.d/limits.conf"
    owner: root
    group: root
    mode: "0644"
  register: _ops_ssh_override

- name: 检查 SSH 服务当前 LimitNOFILE
  ansible.builtin.command:
    cmd: "systemctl show {{ _ops_ssh_service }} --property=LimitNOFILE"
  register: _ops_ssh_current_limit
  changed_when: false

- name: 重载 systemd 并重启 SSH 服务
  ansible.builtin.systemd:
    name: "{{ _ops_ssh_service }}"
    state: restarted
    daemon_reload: true
  when: >
    _ops_ssh_override.changed or
    _ops_nofile_hard | string not in _ops_ssh_current_limit.stdout

# =============================================================================
# PAM pam_limits.so 确认（Debian 系）
# 确保 /etc/pam.d/common-session 中加载了 pam_limits.so
# =============================================================================

- name: 确保 PAM pam_limits.so 已启用 (Debian)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-session
    regexp: '^session\s+required\s+pam_limits\.so'
    line: "session required\tpam_limits.so"
    state: present
  when: ansible_os_family == "Debian"
