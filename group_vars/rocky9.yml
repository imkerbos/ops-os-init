---
# =============================================================================
# ops-os-init 全局变量 — Rocky Linux 9
# =============================================================================

# -----------------------------------------------------------------------------
# 基础系统配置 (init-facts)
# -----------------------------------------------------------------------------

# 主机名（留空则跳过设置）
ops_hostname: ""

# 时区
ops_timezone: "Asia/Shanghai"

# Locale
ops_locale: "en_US.UTF-8"

# DNS 服务器
ops_dns_servers:
  - "8.8.8.8"
  - "1.1.1.1"
  - "8.8.4.4"

ops_dns_search: []

# NTP 服务器
ops_ntp_servers:
  - "time.cloudflare.com"
  - "time.google.com"
  - "pool.ntp.org"

# logrotate 基础配置
ops_logrotate_frequency: "weekly"
ops_logrotate_rotate: 4
ops_logrotate_maxsize: "100M"

# 全局 Shell Alias（写入 /etc/profile.d/ops-alias.sh）
ops_shell_aliases:
  - alias: "docker-compose"
    command: "docker compose"
  - alias: "ll"
    command: "ls -lh --color=auto"
  - alias: "la"
    command: "ls -lAh --color=auto"

# -----------------------------------------------------------------------------
# 内核资源限制 (init-kernel)
# -----------------------------------------------------------------------------

ops_limits:
  - domain: "*"
    type: "soft"
    item: "nofile"
    value: 655360
  - domain: "*"
    type: "hard"
    item: "nofile"
    value: 655360
  - domain: "*"
    type: "soft"
    item: "nproc"
    value: 131072
  - domain: "*"
    type: "hard"
    item: "nproc"
    value: 131072
  - domain: "*"
    type: "soft"
    item: "memlock"
    value: "unlimited"
  - domain: "*"
    type: "hard"
    item: "memlock"
    value: "unlimited"
  - domain: "*"
    type: "soft"
    item: "core"
    value: 0
  - domain: "*"
    type: "hard"
    item: "core"
    value: 0

# -----------------------------------------------------------------------------
# Sysctl 参数 (init-sysctl)
# -----------------------------------------------------------------------------

ops_sysctl_params:
  # --- TCP 优化 ---
  net.ipv4.tcp_fin_timeout: 15
  net.ipv4.tcp_tw_reuse: 1
  net.ipv4.tcp_keepalive_time: 600
  net.ipv4.tcp_keepalive_intvl: 30
  net.ipv4.tcp_keepalive_probes: 3
  net.ipv4.tcp_max_syn_backlog: 8192
  net.ipv4.tcp_syncookies: 1
  net.ipv4.tcp_syn_retries: 2
  net.ipv4.tcp_synack_retries: 2
  net.ipv4.tcp_slow_start_after_idle: 0
  net.ipv4.tcp_mtu_probing: 1
  net.ipv4.tcp_rmem: "4096 87380 16777216"
  net.ipv4.tcp_wmem: "4096 65536 16777216"

  # --- 网络核心 ---
  net.core.somaxconn: 32768
  net.core.netdev_max_backlog: 16384
  net.core.rmem_max: 16777216
  net.core.wmem_max: 16777216

  # --- IPv4 安全 ---
  net.ipv4.ip_forward: 0
  net.ipv4.conf.all.rp_filter: 1
  net.ipv4.conf.default.rp_filter: 1
  net.ipv4.conf.all.accept_redirects: 0
  net.ipv4.conf.default.accept_redirects: 0
  net.ipv4.conf.all.send_redirects: 0
  net.ipv4.conf.default.send_redirects: 0
  net.ipv4.conf.all.accept_source_route: 0
  net.ipv4.conf.default.accept_source_route: 0
  net.ipv4.ip_local_port_range: "10000 65535"

  # --- IPv6（默认禁用）---
  net.ipv6.conf.all.disable_ipv6: 1
  net.ipv6.conf.default.disable_ipv6: 1

  # --- 文件系统 ---
  fs.file-max: 2097152
  fs.nr_open: 2097152
  fs.inotify.max_user_watches: 524288
  fs.inotify.max_user_instances: 8192

  # --- 虚拟内存 ---
  vm.swappiness: 10
  vm.max_map_count: 262144
  vm.dirty_ratio: 20
  vm.dirty_background_ratio: 5

  # --- 内核安全 ---
  kernel.sysrq: 0
  kernel.pid_max: 4194304
  kernel.dmesg_restrict: 1
  kernel.kptr_restrict: 2
  kernel.yama.ptrace_scope: 1
  kernel.randomize_va_space: 2
  fs.suid_dumpable: 0

  # --- 网络安全（增强）---
  net.ipv4.conf.all.log_martians: 1
  net.ipv4.conf.default.log_martians: 1
  net.ipv4.icmp_echo_ignore_broadcasts: 1
  net.ipv4.icmp_ignore_bogus_error_responses: 1
  net.ipv4.conf.all.secure_redirects: 0
  net.ipv4.conf.default.secure_redirects: 0
  net.ipv6.conf.all.accept_redirects: 0
  net.ipv6.conf.default.accept_redirects: 0
  net.ipv6.conf.all.accept_source_route: 0
  net.ipv6.conf.default.accept_source_route: 0

# -----------------------------------------------------------------------------
# 用户管理 (init-users)
# -----------------------------------------------------------------------------

ops_users:
  - name: ops
    shell: /bin/bash
    groups:
      - wheel
    sudo_nopasswd: true
    ssh_key_file: ops.pub
    home_mode: "0750"

ops_users_lock:
  - lp
  - sync
  - shutdown
  - halt
  - operator
  - games
  - ftp

# 密码老化 (/etc/login.defs)
ops_password_max_days: 90
ops_password_min_days: 7
ops_password_warn_age: 14

# 密码复杂度 (pam_pwquality)
ops_pwquality_minlen: 12
ops_pwquality_dcredit: -1
ops_pwquality_ucredit: -1
ops_pwquality_lcredit: -1
ops_pwquality_ocredit: -1
ops_pwquality_minclass: 3
ops_pwquality_maxrepeat: 3
ops_pwquality_retry: 3

# 密码历史
ops_pwhistory_remember: 5

# 账户锁定 (pam_faillock)
ops_faillock_deny: 5
ops_faillock_unlock_time: 900
ops_faillock_fail_interval: 900

# su 限制
ops_su_restrict_wheel: true

# 全局 umask + 会话超时
ops_umask: "027"
ops_tmout: 600

# -----------------------------------------------------------------------------
# SSH 加固 (init-ssh)
# -----------------------------------------------------------------------------

ops_ssh_port: 22
ops_ssh_permit_root_login: "no"
ops_ssh_password_authentication: "no"
ops_ssh_max_auth_tries: 3
ops_ssh_client_alive_interval: 300
ops_ssh_client_alive_count_max: 3
ops_ssh_x11_forwarding: "no"
ops_ssh_allow_tcp_forwarding: "no"
ops_ssh_max_sessions: 10

# 应急 SSH
ops_ssh_emergency_enabled: true
ops_ssh_emergency_port: 22222
ops_ssh_emergency_permit_root_login: "yes"
ops_ssh_emergency_password_authentication: "yes"

# 加密算法
ops_ssh_ciphers: "aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes128-gcm@openssh.com"
ops_ssh_macs: "hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256"
ops_ssh_kex_algorithms: "curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512"
ops_ssh_host_key_algorithms: "ssh-ed25519,ecdsa-sha2-nistp521,ecdsa-sha2-nistp384,ecdsa-sha2-nistp256,rsa-sha2-512,rsa-sha2-256"

# 额外安全参数
ops_ssh_login_grace_time: 30
ops_ssh_max_startups: "10:30:60"
ops_ssh_log_level: "VERBOSE"
ops_ssh_permit_user_environment: "no"

# 登录横幅
ops_ssh_banner_enabled: true
ops_ssh_banner_text: |
  ========================================================
  WARNING: Authorized access only.
  All activity is monitored and recorded.
  Unauthorized access is strictly prohibited.
  ========================================================

# -----------------------------------------------------------------------------
# 服务管理 (init-services)
# -----------------------------------------------------------------------------

ops_services_disable:
  - cups
  - avahi-daemon
  - ModemManager
  - bluetooth
  - kdump
  - iscsi
  - iscsid
  - multipathd
  - rpcbind
  - nfs-client.target
  - remote-fs.target
  - sssd
  - sssd-kcm

ops_services_enable:
  - chronyd
  - rsyslog
  - sshd
  - crond
  - NetworkManager

# -----------------------------------------------------------------------------
# 包管理 (init-packages)
# -----------------------------------------------------------------------------

ops_packages_install:
  - vim-enhanced
  - curl
  - wget
  - net-tools
  - lsof
  - htop
  - iotop
  - sysstat
  - strace
  - tcpdump
  - bind-utils
  - telnet
  - unzip
  - tar
  - rsync
  - tree
  - jq
  - bash-completion
  - chrony
  - logrotate
  - psmisc
  - procps-ng
  - iproute
  - iputils
  - tmux
  - yum-utils
  - audit
  - libpwquality

ops_packages_remove:
  - cockpit
  - cockpit-ws
  - cockpit-system
  - cockpit-bridge
  - PackageKit
  - PackageKit-command-not-found

# -----------------------------------------------------------------------------
# 日志审计 (init-audit)
# -----------------------------------------------------------------------------

ops_audit_enabled: true
ops_audit_max_log_file: 50
ops_audit_num_logs: 5
ops_audit_max_log_file_action: rotate
ops_audit_space_left_action: syslog
ops_audit_admin_space_left_action: halt

ops_audit_rules:
  # 时间变更
  - -a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
  - -a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
  - -a always,exit -F arch=b64 -S clock_settime -k time-change
  - -a always,exit -F arch=b32 -S clock_settime -k time-change
  - -w /etc/localtime -p wa -k time-change

  # 用户/组变更
  - -w /etc/passwd -p wa -k identity
  - -w /etc/shadow -p wa -k identity
  - -w /etc/group -p wa -k identity
  - -w /etc/gshadow -p wa -k identity

  # 网络配置变更
  - -w /etc/hosts -p wa -k system-network
  - -w /etc/resolv.conf -p wa -k system-network
  - -w /etc/sysconfig/network -p wa -k system-network

  # 登录/登出事件
  - -w /var/log/lastlog -p wa -k logins
  - -w /var/log/wtmp -p wa -k logins
  - -w /var/log/btmp -p wa -k logins
  - -w /var/run/faillock -p wa -k logins

  # sudo 和权限提升
  - -w /etc/sudoers -p wa -k sudoers
  - -w /etc/sudoers.d/ -p wa -k sudoers

  # cron 变更
  - -w /etc/crontab -p wa -k cron
  - -w /etc/cron.d/ -p wa -k cron
  - -w /etc/cron.daily/ -p wa -k cron
  - -w /etc/cron.hourly/ -p wa -k cron
  - -w /etc/cron.weekly/ -p wa -k cron
  - -w /etc/cron.monthly/ -p wa -k cron
  - -w /var/spool/cron/ -p wa -k cron

  # SSH 配置变更
  - -w /etc/ssh/sshd_config -p wa -k sshd
  - -w /etc/ssh/sshd_config.d/ -p wa -k sshd

  # 内核模块
  - -a always,exit -F arch=b64 -S init_module -S finit_module -S delete_module -k modules
  - -a always,exit -F arch=b32 -S init_module -S finit_module -S delete_module -k modules

# -----------------------------------------------------------------------------
# 定时任务安全 (init-cron)
# -----------------------------------------------------------------------------

ops_cron_allow_users:
  - root
  - ops

ops_cron_at_allow_users:
  - root
  - ops

# -----------------------------------------------------------------------------
# 关键文件权限 (init-fileperm)
# -----------------------------------------------------------------------------

ops_file_permissions:
  # 账号文件
  - { path: /etc/passwd, owner: root, group: root, mode: "0644" }
  - { path: /etc/shadow, owner: root, group: root, mode: "0000" }
  - { path: /etc/gshadow, owner: root, group: root, mode: "0000" }
  - { path: /etc/group, owner: root, group: root, mode: "0644" }
  - { path: /etc/passwd-, owner: root, group: root, mode: "0600" }
  - { path: /etc/shadow-, owner: root, group: root, mode: "0600" }
  - { path: /etc/gshadow-, owner: root, group: root, mode: "0600" }
  - { path: /etc/group-, owner: root, group: root, mode: "0600" }
  # SSH
  - { path: /etc/ssh/sshd_config, owner: root, group: root, mode: "0600" }
  # Cron
  - { path: /etc/crontab, owner: root, group: root, mode: "0600" }
  # GRUB
  - { path: /boot/grub2/grub.cfg, owner: root, group: root, mode: "0600" }
