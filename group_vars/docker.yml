---
# =============================================================================
# 容器宿主机覆盖参数 — Docker / Podman
# =============================================================================
# 此文件仅包含需要覆盖 rocky9.yml 默认值的参数
# 未列出的参数自动继承 group_vars/rocky9.yml
# =============================================================================

ops_sysctl_params:
  # --- TCP 优化（继承通用值）---
  net.ipv4.tcp_fin_timeout: 15
  net.ipv4.tcp_tw_reuse: 1
  net.ipv4.tcp_keepalive_time: 600
  net.ipv4.tcp_keepalive_intvl: 30
  net.ipv4.tcp_keepalive_probes: 3
  net.ipv4.tcp_max_syn_backlog: 8192
  net.ipv4.tcp_syncookies: 1
  net.ipv4.tcp_syn_retries: 2
  net.ipv4.tcp_synack_retries: 2
  net.ipv4.tcp_slow_start_after_idle: 0
  net.ipv4.tcp_mtu_probing: 1
  net.ipv4.tcp_rmem: "4096 87380 16777216"
  net.ipv4.tcp_wmem: "4096 65536 16777216"

  # --- 网络核心 ---
  net.core.somaxconn: 32768
  net.core.netdev_max_backlog: 16384
  net.core.rmem_max: 16777216
  net.core.wmem_max: 16777216

  # --- IPv4（容器网络必须开启转发）---
  net.ipv4.ip_forward: 1               # ← 必须开启，容器网络依赖（通用值 0）
  net.ipv4.conf.all.rp_filter: 1
  net.ipv4.conf.default.rp_filter: 1
  net.ipv4.conf.all.accept_redirects: 0
  net.ipv4.conf.default.accept_redirects: 0
  net.ipv4.conf.all.send_redirects: 0
  net.ipv4.conf.default.send_redirects: 0
  net.ipv4.conf.all.accept_source_route: 0
  net.ipv4.conf.default.accept_source_route: 0
  net.ipv4.ip_local_port_range: "10000 65535"

  # --- IPv6（容器可能需要 IPv6）---
  net.ipv6.conf.all.disable_ipv6: 0    # ← 开启 IPv6（通用值 1 禁用）
  net.ipv6.conf.default.disable_ipv6: 0
  net.ipv6.conf.all.forwarding: 1      # ← IPv6 转发

  # --- Bridge（容器网桥 iptables 规则）---
  net.bridge.bridge-nf-call-iptables: 1   # ← Docker/K8s 必须
  net.bridge.bridge-nf-call-ip6tables: 1

  # --- 文件系统 ---
  fs.file-max: 2097152
  fs.nr_open: 2097152
  fs.inotify.max_user_watches: 1048576  # ← 容器多实例需要更多 watch（通用值 524288）
  fs.inotify.max_user_instances: 65536  # ← 容器多实例（通用值 8192）

  # --- 虚拟内存 ---
  vm.swappiness: 10
  vm.max_map_count: 524288              # ← Elasticsearch 等容器需要更大（通用值 262144）
  vm.dirty_ratio: 20
  vm.dirty_background_ratio: 5

  # --- 内核 ---
  kernel.sysrq: 0
  kernel.pid_max: 4194304

# --- 内核资源限制（容器宿主机）---
ops_limits:
  - domain: "*"
    type: "soft"
    item: "nofile"
    value: 1048576                      # ← 容器多实例需要更多（通用值 655360）
  - domain: "*"
    type: "hard"
    item: "nofile"
    value: 1048576
  - domain: "*"
    type: "soft"
    item: "nproc"
    value: "unlimited"                  # ← 容器不限制进程数（通用值 131072）
  - domain: "*"
    type: "hard"
    item: "nproc"
    value: "unlimited"
  - domain: "*"
    type: "soft"
    item: "memlock"
    value: "unlimited"
  - domain: "*"
    type: "hard"
    item: "memlock"
    value: "unlimited"
  - domain: "*"
    type: "soft"
    item: "core"
    value: 0
  - domain: "*"
    type: "hard"
    item: "core"
    value: 0

# --- SSH（允许 TCP 转发，方便容器调试）---
ops_ssh_allow_tcp_forwarding: "yes"

# --- Docker 安装 ---
ops_docker_enabled: true

# --- 服务管理（追加 docker/containerd）---
ops_services_enable:
  - chronyd
  - rsyslog
  - sshd
  - crond
  - NetworkManager
  - docker
  - containerd
