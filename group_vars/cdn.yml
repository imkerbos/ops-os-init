---
# =============================================================================
# CDN / 反向代理节点覆盖参数 — Nginx / HAProxy 等
# =============================================================================
# 此文件仅包含需要覆盖 rocky9.yml 默认值的参数
# 未列出的参数自动继承 group_vars/rocky9.yml
# =============================================================================

ops_sysctl_params:
  # --- TCP 优化（CDN 高并发调优）---
  net.ipv4.tcp_fin_timeout: 10          # ← 更激进回收（通用值 15）
  net.ipv4.tcp_tw_reuse: 1
  net.ipv4.tcp_keepalive_time: 300      # ← 更短保活，快速释放空闲连接（通用值 600）
  net.ipv4.tcp_keepalive_intvl: 15
  net.ipv4.tcp_keepalive_probes: 3
  net.ipv4.tcp_max_syn_backlog: 65535   # ← 大幅提升 SYN 队列（通用值 8192）
  net.ipv4.tcp_syncookies: 1
  net.ipv4.tcp_syn_retries: 1           # ← 快速失败（通用值 2）
  net.ipv4.tcp_synack_retries: 1
  net.ipv4.tcp_slow_start_after_idle: 0
  net.ipv4.tcp_mtu_probing: 1
  net.ipv4.tcp_rmem: "4096 87380 33554432"   # ← 接收缓冲区加倍到 32MB（通用值 16MB）
  net.ipv4.tcp_wmem: "4096 65536 33554432"   # ← 发送缓冲区加倍到 32MB
  net.ipv4.tcp_max_tw_buckets: 2000000  # ← TIME_WAIT 桶数量（CDN 大量短连接）
  net.ipv4.tcp_fastopen: 3             # ← 启用 TCP Fast Open（客户端+服务端）

  # --- 网络核心（CDN 高吞吐）---
  net.core.somaxconn: 65535             # ← 最大监听队列（通用值 32768）
  net.core.netdev_max_backlog: 65535    # ← 网卡积压队列（通用值 16384）
  net.core.rmem_max: 33554432           # ← 接收缓冲区 32MB（通用值 16MB）
  net.core.wmem_max: 33554432           # ← 发送缓冲区 32MB
  net.core.rmem_default: 262144
  net.core.wmem_default: 262144

  # --- IPv4 安全 ---
  net.ipv4.ip_forward: 0
  net.ipv4.conf.all.rp_filter: 1
  net.ipv4.conf.default.rp_filter: 1
  net.ipv4.conf.all.accept_redirects: 0
  net.ipv4.conf.default.accept_redirects: 0
  net.ipv4.conf.all.send_redirects: 0
  net.ipv4.conf.default.send_redirects: 0
  net.ipv4.conf.all.accept_source_route: 0
  net.ipv4.conf.default.accept_source_route: 0
  net.ipv4.ip_local_port_range: "1024 65535"  # ← 更大端口范围（通用值 10000-65535）

  # --- IPv6 ---
  net.ipv6.conf.all.disable_ipv6: 1
  net.ipv6.conf.default.disable_ipv6: 1

  # --- 文件系统（CDN 大量文件句柄）---
  fs.file-max: 4194304                  # ← 翻倍（通用值 2097152）
  fs.nr_open: 4194304
  fs.inotify.max_user_watches: 524288
  fs.inotify.max_user_instances: 8192

  # --- 虚拟内存 ---
  vm.swappiness: 10
  vm.max_map_count: 262144
  vm.dirty_ratio: 20
  vm.dirty_background_ratio: 5

  # --- 内核 ---
  kernel.sysrq: 0
  kernel.pid_max: 4194304
  kernel.dmesg_restrict: 1
  kernel.kptr_restrict: 2
  kernel.yama.ptrace_scope: 1
  kernel.randomize_va_space: 2
  fs.suid_dumpable: 0

  # --- 网络安全（增强）---
  net.ipv4.conf.all.log_martians: 1
  net.ipv4.conf.default.log_martians: 1
  net.ipv4.icmp_echo_ignore_broadcasts: 1
  net.ipv4.icmp_ignore_bogus_error_responses: 1
  net.ipv4.conf.all.secure_redirects: 0
  net.ipv4.conf.default.secure_redirects: 0
  net.ipv6.conf.all.accept_redirects: 0
  net.ipv6.conf.default.accept_redirects: 0
  net.ipv6.conf.all.accept_source_route: 0
  net.ipv6.conf.default.accept_source_route: 0

# --- 内核资源限制（CDN 高并发）---
ops_limits:
  - domain: "*"
    type: "soft"
    item: "nofile"
    value: 1048576                      # ← 百万级文件句柄（通用值 655360）
  - domain: "*"
    type: "hard"
    item: "nofile"
    value: 1048576
  - domain: "*"
    type: "soft"
    item: "nproc"
    value: 131072
  - domain: "*"
    type: "hard"
    item: "nproc"
    value: 131072
  - domain: "*"
    type: "soft"
    item: "memlock"
    value: "unlimited"
  - domain: "*"
    type: "hard"
    item: "memlock"
    value: "unlimited"
  - domain: "*"
    type: "soft"
    item: "core"
    value: 0
  - domain: "*"
    type: "hard"
    item: "core"
    value: 0

# --- 用户管理（追加 cdnops 用户）---
ops_users:
  - name: ops
    shell: /bin/bash
    groups:
      - wheel
    sudo_nopasswd: true
    ssh_key_file: ops.pub
    home_mode: "0750"
  - name: cdnops
    shell: /bin/bash
    groups:
      - wheel
    sudo_nopasswd: true
    ssh_key_file: cdnops.pub
    home_mode: "0750"

# --- 定时任务（追加 cdnops）---
ops_cron_allow_users:
  - root
  - ops
  - cdnops
